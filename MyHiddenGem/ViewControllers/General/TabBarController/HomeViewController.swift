//
//  HomeViewController.swift
//  MyHiddenGem
//
//  Created by Í∂åÏ†ïÍ∑º on 4/23/25.
//

import UIKit
import Combine

class HomeViewController: UIViewController {
    
    // MARK: - Variable
    
    private let categoriesViewModel: CategoryViewModel = CategoryViewModel()
    private let eateriesViewModel: EateryViewModel = EateryViewModel()
    private let regionCodeViewModel: RegionViewModel = RegionViewModel()
    private var loadingViewModel: LoadingViewModel!
    
    private var cancellables: Set<AnyCancellable> = []
    
    private var dataSource: UICollectionViewDiffableDataSource<EaterySection, EateryItemType>?
    
    
    // MARK: - UI Componnets
    
    private var recommendationCollectionView: UICollectionView!
    private let activityIndicator = UIActivityIndicatorView(style: .large)
    
    
    // MARK: - Life Cycle
    
    override func viewDidLoad() {
        super.viewDidLoad()
        view.backgroundColor = .systemBackground
        
        setupHeaderView(with: "Ìà¨Îç∞Ïù¥")
        setupHeaderButtons()
        
        bindLoading()
        
        bindViewModel()
        fetchCategories()
        
        setupCollectionView()
        createDataSource()
        
        recommendationCollectionView.delegate = self
    }
    
    
    override func viewWillAppear(_ animated: Bool) {
        super.viewWillAppear(animated)
        
        // CategoryCell ÎÇ¥Ïóê ÎùºÎ≤†ÏùÑ ÏÑ†ÌÉùÌïú Í≤ÉÏùÑ Ï¥àÍ∏∞Ìôî
        recommendationCollectionView.indexPathsForSelectedItems?.forEach { recommendationCollectionView.deselectItem(at: $0, animated: false)
        }
    }
    
    
    // MARK: - Functions
    
    /// recommendationCollectionView UI ÏÖãÌåÖ Î©îÏÑúÎìú
    private func setupCollectionView() {
        
        recommendationCollectionView = UICollectionView(frame: view.bounds, collectionViewLayout: createCompostionalLayout())
        recommendationCollectionView.autoresizingMask = [.flexibleWidth, .flexibleHeight]
        recommendationCollectionView.backgroundColor = .systemBackground
        recommendationCollectionView.showsVerticalScrollIndicator = false
        
        view.addSubview(recommendationCollectionView)
        view.addSubview(activityIndicator)
        
        activityIndicator.center = view.center
        
        recommendationCollectionView.register(RecommendationCell.self, forCellWithReuseIdentifier: RecommendationCell.reuseIdentifier)
        
        recommendationCollectionView.register(CategoryCell.self, forCellWithReuseIdentifier: CategoryCell.reuseIdentifier)
        
        recommendationCollectionView.register(GyeonggiCell.self, forCellWithReuseIdentifier: GyeonggiCell.reuseIdentifier)
        
        recommendationCollectionView.register(SectionHeader.self, forSupplementaryViewOfKind: UICollectionView.elementKindSectionHeader, withReuseIdentifier: SectionHeader.reuseIdentifier)
    }
    
    
    /// Ïª¨Î†âÏÖò Î∑∞Ïóê ÌëúÏãúÌï† Îç∞Ïù¥ÌÑ∞Î•º Íµ¨ÏÑ±ÌïòÍ≥† Ï†ÅÏö©ÌïòÎäî Î©îÏÑúÎìú
    private func reloadData() {
        var snapshot = NSDiffableDataSourceSnapshot<EaterySection, EateryItemType>()
        
        snapshot.appendSections([.category, .list, .gyeonggido, .seoul, .incheon, .regionCode])
        
        snapshot.appendItems(categoriesViewModel.emojiCategories.map { .category($0) }, toSection: .category)
        snapshot.appendItems(eateriesViewModel.eateries.map { .eatery($0) }, toSection: .list)
        snapshot.appendItems(eateriesViewModel.gyeonggiEateries.map { .gyeonggido($0)}, toSection: .gyeonggido)
        snapshot.appendItems(eateriesViewModel.seoulEateries.map { .seoul($0)}, toSection: .seoul)
        snapshot.appendItems(eateriesViewModel.incheonEateries.map { .incheon($0)}, toSection: .incheon)
        snapshot.appendItems(regionCodeViewModel.regionList.map { .regionCode($0)} ,toSection: .regionCode)
        
        dataSource?.apply(snapshot, animatingDifferences: true)
    }
    
    
    private func createDataSource() {
        dataSource = UICollectionViewDiffableDataSource<EaterySection, EateryItemType>(collectionView: recommendationCollectionView) { collectionView, indexPath, item in
            
            switch item {
                
            case .eatery(let eatery):
                let cell = collectionView.dequeueReusableCell(withReuseIdentifier: RecommendationCell.reuseIdentifier, for: indexPath) as? RecommendationCell
                cell?.configure(with: eatery)
                return cell
                
            case .category(let category):
                let cell = collectionView.dequeueReusableCell(withReuseIdentifier: CategoryCell.reuseIdentifier, for: indexPath) as? CategoryCell
                let emojiCategory = "\(category.icon) \(category.name)"
                cell?.configure(with: emojiCategory)
                return cell
                
            case .gyeonggido(let gyeonggido):
                let cell =
                collectionView.dequeueReusableCell(withReuseIdentifier: GyeonggiCell.reuseIdentifier, for: indexPath) as? GyeonggiCell
                
                cell?.configure(with: gyeonggido)
                return cell
                
            case .seoul(let seoul):
                let cell = collectionView.dequeueReusableCell(withReuseIdentifier: GyeonggiCell.reuseIdentifier, for: indexPath) as? GyeonggiCell
                
                cell?.configure(with: seoul)
                return cell
                
            case .incheon(let incheon):
                let cell = collectionView.dequeueReusableCell(withReuseIdentifier: GyeonggiCell.reuseIdentifier, for: indexPath) as? GyeonggiCell
                
                cell?.configure(with: incheon)
                return cell
            case .regionCode(let region):
                let cell = collectionView.dequeueReusableCell(withReuseIdentifier: CategoryCell.reuseIdentifier, for: indexPath) as? CategoryCell
                cell?.configure(with: region.name)
                return cell
            }
        }
        
        dataSource?.supplementaryViewProvider = { [weak self] collectionView, kind, indexPath in
            
            // ‚úÖ Ìó§Îçî Î∑∞ dequeue
            guard let sectionHeader = collectionView.dequeueReusableSupplementaryView(
                ofKind: kind,
                withReuseIdentifier: SectionHeader.reuseIdentifier,
                for: indexPath
            ) as? SectionHeader else {
                return nil
            }
            
            
            // ÏÑπÏÖò Î≤àÌò∏ -> EaterySection Î≥ÄÌôò
            guard let section = EaterySection(rawValue: indexPath.section) else { return nil }
            
            // ÌäπÏ†ï ÏÑπÏÖòÏóêÎäî Ìó§Îçî ÏïàÎ≥¥Ïù¥Í≤å Ï≤òÎ¶¨
            switch section {
            case .category, .list:
                return nil
            case .gyeonggido:
                sectionHeader.configure(main: "Î∂ÄÎåÄÏ∞åÍ∞úÎßå ÏûàÎäîÍ≤å ÏïÑÎãàÏ£† üôÖ", sub: "Îã§ÏñëÌïú ÏùåÏãùÏù¥ ÏûàÎäî ÎèÑÏãú, Í≤ΩÍ∏∞ÎèÑ")
                return sectionHeader
            case .seoul:
                sectionHeader.configure(main: "ÎÇ®ÏÇ∞ÎèàÍ∞ÄÏä§ Îòê Î®πÏñ¥Ïöî? ü§∑", sub: "Î®πÏùÑÍ≤å ÎÑòÏπòÎäî ÎèÑÏãú, ÏÑúÏö∏")
                return sectionHeader
            case .incheon:
                sectionHeader.configure(main: "Ï†ìÍµ≠Í∞àÎπÑ Î®πÏñ¥Î¥§Ïñ¥Ïöî? üôÜ", sub: "ÏßúÏû•Î©¥, Ï´ÑÎ©¥Ïùò ÎèÑÏãú, Ïù∏Ï≤ú")
                return sectionHeader
            case .regionCode:
                sectionHeader.configure(main: "ÏßÄÏó≠ Íµ¨Î∂Ñ üåê", sub: "ÏßÄÏó≠Î≥Ñ ÏùåÏãùÏ†ê ÏÜåÍ∞ú")
                return sectionHeader
            }
        }
    }
    
    /// recommendationCollectionView ÌÜµÌï© UI Í¥ÄÎ¶¨ÌïòÎäî Î©îÏÑúÎìú
    private func createCompostionalLayout() -> UICollectionViewLayout {
        let layout = UICollectionViewCompositionalLayout { sectionIndex, environment in
            let sectionIdentifier = EaterySection.allCases[sectionIndex]
            
            switch sectionIdentifier {
            case .category:
                return self.createCategorySection(using: self.categoriesViewModel.categories)
                
            case .list:
                return self.createFeaturedSection(using: self.eateriesViewModel.eateries)
                
            case .gyeonggido:
                return self.createMediumSection(using: self.eateriesViewModel.gyeonggiEateries)
                
            case .seoul:
                return self.createMediumSection(using: self.eateriesViewModel.seoulEateries)
                
            case .incheon:
                return self.createMediumSection(using: self.eateriesViewModel.incheonEateries)
                
            case .regionCode:
                return self.createRegionSection(using: self.regionCodeViewModel.regionList)
                
            }
        }
        
        let config = UICollectionViewCompositionalLayoutConfiguration()
        config.interSectionSpacing = 20
        layout.configuration = config
        return layout
    }
    
    
    /// Ïò§ÎäòÏùò ÏùåÏãùÏ†ê Ï†ïÎ≥¥ UIÎ•º Îã¥ÎãπÌïòÎäî Î©îÏÑúÎìú
    private func createFeaturedSection(using section: [EateryItem]) -> NSCollectionLayoutSection {
        let itemSize = NSCollectionLayoutSize(widthDimension: .fractionalWidth(1), heightDimension: .fractionalHeight(1))
        
        let layoutItem = NSCollectionLayoutItem(layoutSize: itemSize)
        layoutItem.contentInsets = NSDirectionalEdgeInsets(top: 0, leading: 5, bottom: 0, trailing: 5)
        
        let layoutGroupSize = NSCollectionLayoutSize(widthDimension: .fractionalWidth(0.93), heightDimension: .estimated(300))
        let layoutGroup = NSCollectionLayoutGroup.horizontal(layoutSize: layoutGroupSize, subitems: [layoutItem])
        
        let layoutSection = NSCollectionLayoutSection(group: layoutGroup)
        layoutSection.orthogonalScrollingBehavior = .groupPagingCentered
        
        return layoutSection
    }
    
    
    /// ÏùåÏãùÏ†ê Ïπ¥ÌÖåÍ≥†Î¶¨ UIÎ•º Îã¥ÎãπÌïòÎäî Î©îÏÑúÎìú
    private func createCategorySection(using section: [StoreCategory]) -> NSCollectionLayoutSection {
        let itemSize = NSCollectionLayoutSize(
            widthDimension: .estimated(70),
            heightDimension: .absolute(35)
        )
        let item = NSCollectionLayoutItem(layoutSize: itemSize)
        
        let groupSize = NSCollectionLayoutSize(
            widthDimension: .estimated(70),
            heightDimension: .absolute(35)
        )
        let group = NSCollectionLayoutGroup.horizontal(layoutSize: groupSize, subitems: [item])
        
        let section = NSCollectionLayoutSection(group: group)
        section.orthogonalScrollingBehavior = .continuous
        section.interGroupSpacing = 8
        section.contentInsets = NSDirectionalEdgeInsets(top: 0, leading: 16, bottom: 0, trailing: 16)
        
        return section
    }
    
    ///  ÏßÄÏó≠Î≥Ñ ÏùåÏãùÏ†ê ÏÜåÍ∞ú UIÎ•º Îã¥ÎãπÌïòÎäî Î©îÏÑúÎìú
    private func createMediumSection(using section: [EateryItem]) -> NSCollectionLayoutSection {
        let itemSize = NSCollectionLayoutSize(widthDimension: .fractionalWidth(0.97), heightDimension: .fractionalHeight(0.33))
        
        let layoutItem = NSCollectionLayoutItem(layoutSize: itemSize)
        layoutItem.contentInsets = NSDirectionalEdgeInsets(top: 0, leading: 5, bottom: 0, trailing: 5)
        
        let layoutGroupSize = NSCollectionLayoutSize(widthDimension: .fractionalWidth(0.93), heightDimension: .fractionalWidth(0.55))
        
        let layoutGroup = NSCollectionLayoutGroup.vertical(layoutSize: layoutGroupSize, subitems: [layoutItem])
        
        let layoutSection = NSCollectionLayoutSection(group: layoutGroup)
        layoutSection.orthogonalScrollingBehavior = .groupPagingCentered
        
        let layoutSectionHeader = createSectionHeader()
        layoutSection.boundarySupplementaryItems = [layoutSectionHeader]
        
        return layoutSection
    }
    
    
    /// ÏßÄÏó≠ Íµ¨Î∂Ñ ÏÜåÍ∞ú UIÎ•º Îã¥ÎãπÌïòÎäî Î©îÏÑúÎìú
    private func createRegionSection(using section: [RegionCodeModel]) -> NSCollectionLayoutSection {
        let itemSize = NSCollectionLayoutSize(widthDimension: .fractionalWidth(0.97 / 2.0), heightDimension: .fractionalHeight(1.0))
        
        let layoutItem = NSCollectionLayoutItem(layoutSize: itemSize)
        layoutItem.contentInsets = NSDirectionalEdgeInsets(top: 5, leading: 5, bottom: 5, trailing: 5)
        
        let horizontalGroupSize = NSCollectionLayoutSize(
            widthDimension: .fractionalWidth(1.0),
            heightDimension: .absolute(45)
        )
        
        let horizontalGroup = NSCollectionLayoutGroup.horizontal(
            layoutSize: horizontalGroupSize,
            subitems: [layoutItem, layoutItem] )
        
        let verticalGroupSize = NSCollectionLayoutSize(
            widthDimension: .fractionalWidth(0.93),
            heightDimension: .estimated(150)
        )
        
        let verticalGroup = NSCollectionLayoutGroup.vertical(
            layoutSize: verticalGroupSize,
            subitems: [horizontalGroup, horizontalGroup, horizontalGroup]
        )
        
        let layoutSection = NSCollectionLayoutSection(group: verticalGroup)
        layoutSection.orthogonalScrollingBehavior = UICollectionLayoutSectionOrthogonalScrollingBehavior.groupPagingCentered
        
        
        layoutSection.boundarySupplementaryItems = [createSectionHeader()]
        return layoutSection
    }

    
    /// Í∞Å ÏÑπÏÖò Ìó§Îçî UIÎ•º Îã¥ÎãπÌïòÎäî Î©îÏÑúÎìú
    private func createSectionHeader() -> NSCollectionLayoutBoundarySupplementaryItem {
        let layoutSectionHeaderSize = NSCollectionLayoutSize(widthDimension: .fractionalWidth(0.93), heightDimension: .estimated(80))
        let layoutSectionHeader = NSCollectionLayoutBoundarySupplementaryItem(
            layoutSize: layoutSectionHeaderSize,
            elementKind: UICollectionView.elementKindSectionHeader,
            alignment: .top)
        return layoutSectionHeader
    }
}


// MARK: - Extension: ÌôàÌôîÎ©¥ ÏÉÅÎã® View

extension HomeViewController {
    
    /// Ìôà ÌôîÎ©¥ ÏÉÅÎã® Î∑∞ ÏÑ§Ï†ï
    func setupHeaderView(with title: String) {
        let titleLabel: UILabel = UILabel()
        titleLabel.text = title
        titleLabel.font = UIFont.boldSystemFont(ofSize: 24)
        titleLabel.textColor = .label
        
        let leftBarButton = UIBarButtonItem(customView: titleLabel)
        navigationItem.leftBarButtonItem = leftBarButton
    }
    
    
    /// Ìôà ÌôîÎ©¥ ÏÉÅÎã® Ïò§Î•∏Ï™Ω Î≤ÑÌäº ÏÑ§Ï†ï (Í≤ÄÏÉâ, ÏïåÎûå)
    func setupHeaderButtons() {
        let searchButton = UIButton(type: .system)
        searchButton.setImage(UIImage(systemName: "magnifyingglass"), for: .normal)
        searchButton.tintColor = .label
        searchButton.addTarget(self, action: #selector(didTappedSearchButton), for: .touchUpInside)
        let searchBarButton = UIBarButtonItem(customView: searchButton)
        
        let alarmButton = UIButton(type: .system)
        alarmButton.setImage(UIImage(systemName: "bell"), for: .normal)
        alarmButton.tintColor = .label
        alarmButton.addTarget(self, action: #selector(didTappedAlarmButton), for: .touchUpInside)
        
        let alarmBarButton = UIBarButtonItem(customView: alarmButton)
        
        navigationItem.rightBarButtonItems = [alarmBarButton, searchBarButton]
    }
    
    
    // MARK: - Actions
    
    /// Í≤ÄÏÉâ Î≤ÑÌäºÏùÑ ÎàÑÎ•¥Î©¥ ÎèôÏûëÌïòÎäî Ïï°ÏÖò Î©îÏÑúÎìú
    @objc private func didTappedSearchButton() {
        print("Í≤ÄÏÉâ Î≤ÑÌäºÏùÑ ÎàåÎ¶Ñ")
    }
    
    
    /// ÏïåÎûå Î≤ÑÌäºÏùÑ ÎàÑÎ•¥Î©¥ ÎèôÏûëÌïòÎäî Ïï°ÏÖò Î©îÏÑúÎìú
    @objc private func didTappedAlarmButton() {
        print("ÏïåÎûå Î≤ÑÌäºÏùÑ ÎàåÎ¶Ñ")
    }
}


// MARK: - Extension: Î∞îÏù∏Îî© Ìï®Ïàò

extension HomeViewController {
    
    // MARK: - Functions
    
    /// ViewModelÏùò Îç∞Ïù¥ÌÑ∞ Î≥ÄÍ≤Ω Ïãú CollectionView Snapshot Í∞±Ïã†
    private func bindViewModel() {
        
        categoriesViewModel.$emojiCategories
            .combineLatest(eateriesViewModel.$eateries)
            .combineLatest(eateriesViewModel.$gyeonggiEateries)
            .combineLatest(eateriesViewModel.$seoulEateries)
            .combineLatest(eateriesViewModel.$incheonEateries)
            .combineLatest(regionCodeViewModel.$regionList)
            .receive(on: DispatchQueue.main)
            .sink { [weak self] _ in
                self?.reloadData()
            }
            .store(in: &cancellables)
        
    }
    
    /// Í∞Å ViewModelÏóêÏÑú Îç∞Ïù¥ÌÑ∞Î•º Î∞õÏïòÎäîÏßÄ Ïó¨Î∂ÄÎ•º isLoadingÏóê Ï†ÄÏû•, ÎπÑÍµêÌïòÏó¨ Í∞êÏßÄÌïòÎäî Î©îÏÑúÎìú
    private func bindLoading() {
        loadingViewModel = LoadingViewModel(
            eateryVM: eateriesViewModel,
            categoryVM: categoriesViewModel,
            regionVM: regionCodeViewModel
        )
        
        loadingViewModel.$isLoading
            .receive(on: DispatchQueue.main)
            .sink { [weak self] isLoading in
                if isLoading {
                    self?.activityIndicator.startAnimating()
                    self?.recommendationCollectionView.isHidden = true
                } else {
                    self?.activityIndicator.stopAnimating()
                    self?.recommendationCollectionView.isHidden = false
                    self?.recommendationCollectionView.reloadData()
                }
            }
            .store(in: &cancellables)
    }
    
    /// ÏùåÏãùÏ†ê Î¶¨Ïä§Ìä∏Î•º Ïô∏Î∂ÄÏóêÏÑú ÏöîÏ≤≠ÌïòÎäî Î©îÏÑúÎìú
    private func fetchCategories() {
        
        // Í∞ÅÍ∞ÅÏùò Ìï®ÏàòÍ∞Ä ÎèÖÎ¶ΩÏ†ÅÏúºÎ°ú Ïã§Ìñâ
        Task {
            async let categoriesFetch: () = categoriesViewModel.fetchCategories()
            async let eateriesFetch: () = eateriesViewModel.fetchEateries()
            async let regionFetch: () = regionCodeViewModel.fetchRegionCode()
            
            await categoriesFetch
            categoriesViewModel.updateCategories()
            await eateriesFetch
            await regionFetch
        }
    }
}


// MARK: - Extension: UICollectionViewDelegate

extension HomeViewController: UICollectionViewDelegate {
    func collectionView(_ collectionView: UICollectionView, didSelectItemAt indexPath: IndexPath) {
        
        guard let seletedItem = dataSource?.itemIdentifier(for: indexPath) else { return }
        
        switch seletedItem {
            
        case .category(let category):
            
            
            let categoryVC = CategoryViewController(code: category.code, name: category.name)
            navigationController?.pushViewController(categoryVC, animated: true)
            
        case .eatery(let eatery):
            print("ÏÑ†ÌÉùÎêú ÏùåÏãùÏ†ê: \(eatery.title)")
        case .gyeonggido(let gyeonggido):
            print("ÏÑ†ÌÉùÎêú Í≤ΩÍ∏∞ÎèÑ ÏùåÏãùÏ†ê: \(gyeonggido.title)")
        case .incheon(let incheon):
            print("ÏÑ†ÌÉùÎêú Ïù∏Ï≤ú ÏùåÏãùÏ†ê: \(incheon.title)")
        case .seoul(let seoul):
            print("ÏÑ†ÌÉùÎêú ÏÑúÏö∏ ÏùåÏãùÏ†ê: \(seoul.title)")
        case .regionCode(let region):

            let regionVC = EateryFromRegionViewController(regionCode: region.code, regionName: region.name)
            navigationController?.pushViewController(regionVC, animated: true)
                    
        }
    }
}
